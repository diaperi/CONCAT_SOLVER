<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mainPage</title>
    <script src="https://kit.fontawesome.com/a06d7ad725.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/hyeeun/css/mainpage.css}">
    <link rel="stylesheet" th:href="@{/hyeeun/css/header.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<div th:replace="hyeeun/header :: header"></div>

<div class="myPageDetail_container">
    <div class="myPageDetail_container2">
        <div class="myPageDetail_main">
            <div class="myPageDetail_videoBox slide-out-left" id="videoBox">
                <!--                    <img id="video" src="http://192.168.137.227:5000/video_feed" width="640" height="480">-->
                <img id="video" th:src="${videoFeedUrl}">
                <span class="close-button" id="closeButton"><i class="fa-solid fa-x"></i></span>
            </div>
            <div class="myPageDetail_rightBox visible" id="myPageDetail_rightBox">
                <div class="myPageDetail_rightTop">
                    <span>대화내용</span>
                    <span id="solveBtn">해결책</span>
                    <span id="expandButton"><i class="fa-solid fa-angles-left"></i></span>
                </div>
                <div class="myPageDetail_rightMain">
                    <span id="transcriptResult">대화 내용을 보여드릴게요.<br><br>조금만 기다려 주세요.😀</span>
                </div>
                <div class="myPageDetail_rightMain">
                    <span id="gptResult">솔버가 해결책을 만들고 있어요.<br><br>조금만 기다려 주세요.🫡</span>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="/seoyun/js/myPageDetail.js"></script>
<script th:inline="javascript">
    var userId = /*[[${userId}]]*/ 'defaultUserId'; // userId 값이 제대로 설정되었는지 확인
    console.log("User ID: ", userId); // 이 줄을 추가해 userId 값이 제대로 출력되는지 콘솔에서 확인
</script>
<script>
    function fetchLatestResults() {
        if (!userId || userId === 'defaultUserId') {
            console.error("Invalid userId detected: ", userId);
            return;
        }
        $.ajax({
            url    : "/api/s3/latest-transcript",
            type   : "GET",
            data   : {userId: userId}, // userId 변수를 사용
            success: function (response) {
                const formattedResponse = response.replace(/참여자/g, '<br>참여자');
                $("#transcriptResult").html(formattedResponse); // 최신 화자인식 결과
            },
            error  : function () {
                console.log("화자인식 데이터를 가져오는 데 실패했습니다.");
            }
        });

        $.ajax({
            url    : "/api/s3/latest-gpt-response",
            type   : "GET",
            data   : {userId: userId}, // userId 변수를 사용
            success: function (response) {
                // 텍스트에 <br> 태그 추가
                const formattedResponse = response.replace(/\./g, '.');
                $("#gptResult").html(formattedResponse); // 최신 GPT 결과
            },
            error  : function () {
                console.log("GPT 데이터를 가져오는 데 실패했습니다.");
            }
        });
    }

    // 일정 간격으로 S3 데이터 체크
    setInterval(fetchLatestResults, 5000); // 5초마다 최신 데이터 체크
</script>


</body>
</html>